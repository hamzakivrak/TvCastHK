<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#18191d">
    <title>TV Cast - Kurtarma 2 (Stable)</title>
    
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- TEMEL AYARLAR --- */
        :root { --bg: #0f1014; --panel: #18191d; --surface: #23242a; --primary: #6c5ce7; --text: #fff; --border: #2d2e36; --red: #e74c3c; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- SOL PANEL --- */
        .sidebar { width: 400px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-shadow: 5px 0 20px #000; overflow-y: auto; z-index: 10; flex-shrink: 0;}

        /* --- MODÃœLLER --- */
        .module { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; overflow: hidden; flex-shrink: 0; }
        .module-header { padding: 15px; background: rgba(255,255,255,0.03); cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .module-header:hover { background: rgba(255,255,255,0.06); }
        .module-title { font-size: 0.75rem; font-weight: 700; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; }
        .module-body { padding: 15px; border-top: 1px solid var(--border); }
        .icon-state { transition: transform 0.2s; color: #666; }
        
        /* --- FORM --- */
        input, textarea, select { width: 100%; background: #121212; border: 1px solid var(--border); color: #fff; border-radius: 8px; padding: 10px; box-sizing: border-box; font-family: inherit; }
        textarea { resize: none; height: 60px; margin-bottom: 10px; font-size: 0.8rem; font-family: monospace; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; }
        
        /* --- BUTONLAR --- */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; height: 45px; border: 1px solid var(--border); border-radius: 8px; background: #3d3e46; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn:hover { background: var(--primary); border-color: var(--primary); }
        .btn-icon { padding: 0 15px; background: #3d3e46; color: white; border-radius: 8px; cursor: pointer; border: 1px solid var(--border); }

        /* --- SAÄž Ä°Ã‡ERÄ°K --- */
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .card { background: var(--surface); padding: 12px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid transparent; }
        .card:hover { background: #2f3038; border-color: var(--primary); }
        .card.active { border-color: var(--primary); background: rgba(108, 92, 231, 0.15); }
        .icon-box { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
        .icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .info { overflow: hidden; }
        .name { font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- ARAMA SONUÃ‡LARI --- */
        #searchResults { max-height: 200px; overflow-y: auto; margin-top: 10px; display: none; border-top: 1px solid var(--border); padding-top: 10px; }
        .result-item { padding: 8px; background: #2f3038; margin-bottom: 5px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; }

        /* --- PLAYER BAR --- */
        .player-bar { position: fixed; bottom: 20px; left: 420px; right: 20px; height: 70px; background: rgba(35,36,42,0.95); border-radius: 20px; display: flex; align-items: center; justify-content: center; z-index: 100; pointer-events: none; opacity: 0; transition: 0.3s; }
        .player-bar.show { opacity: 1; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 55vh; padding: 15px; }
            .player-bar { left: 10px; right: 10px; bottom: 10px; }
            .content { padding-bottom: 90px; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="background: #25262c; border: 1px solid var(--primary); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div>
            <h3 style="margin:0; font-size:1rem;">TV Cast</h3>
            <span id="connStatus" style="font-size:0.8rem; color:#aaa;">BaÄŸlantÄ± Bekleniyor...</span>
        </div>
        <google-cast-launcher></google-cast-launcher>
    </div>

    <div class="module">
        <div class="module-header" onclick="toggleModule('mod-github', 'icon-github')">
            <p class="module-title">1. GitHub'da Ara</p>
            <i id="icon-github" class="material-icons-round icon-state">expand_more</i>
        </div>
        <div id="mod-github" class="module-body" style="display:none;">
            <div style="display: flex; gap: 8px;">
                <input type="text" id="searchTerm" placeholder="Ã–rn: Spor, Sinema...">
                <button class="btn-icon" onclick="doSearch()"><i class="material-icons-round">search</i></button>
            </div>
            <a id="backupLink" href="#" target="_blank" style="display:none; font-size:0.7rem; text-align:center; display:block; margin-top:5px; color:var(--primary);">Pencere aÃ§Ä±lmazsa tÄ±kla</a>
        </div>
    </div>

    <div class="module">
        <div class="module-header" onclick="toggleModule('mod-manual', 'icon-manual')">
            <p class="module-title">2. Manuel Link / Script</p>
            <i id="icon-manual" class="material-icons-round icon-state">expand_more</i>
        </div>
        <div id="mod-manual" class="module-body" style="display:none;">
            <div style="text-align:right; margin-bottom:5px;"><span onclick="document.getElementById('inputData').value=''" style="color:var(--red); cursor:pointer; font-size:0.7rem;">Temizle</span></div>
            <textarea id="inputData" placeholder="Script kodunu veya Linki yapÄ±ÅŸtÄ±r..."></textarea>
            <div class="btn-group">
                <button class="btn" onclick="pasteClip()"><i class="material-icons-round">content_paste</i></button>
                <button class="btn" style="background:var(--primary)" onclick="manualLoad()"><i class="material-icons-round">play_arrow</i> YÃ¼kle</button>
            </div>
            <div id="status" style="font-size:0.7rem; text-align:center; margin-top:5px; color:#aaa;"></div>
        </div>
    </div>

    <div class="module">
        <div class="module-header" style="cursor:default;">
            <p class="module-title" style="color:white;">3. HazÄ±r Listeler</p>
        </div>
        <div class="module-body" style="padding-top:0; border:none;">
            <select id="countrySelect" onchange="changeCountry()">
                <option value="tr" selected>ðŸ‡¹ðŸ‡· TÃ¼rkiye (VarsayÄ±lan)</option>
                <option value="https://i.mjh.nz/SamsungTVPlus/tr.m3u8">ðŸŽ¬ YeÅŸilÃ§am & Sinema (TR)</option>
                <option value="us">ðŸ‡ºðŸ‡¸ USA</option>
                <option value="uk">ðŸ‡¬ðŸ‡§ UK</option>
                <option value="de">ðŸ‡©ðŸ‡ª Germany</option>
                <option value="fr">ðŸ‡«ðŸ‡· France</option>
                <option value="ru">ðŸ‡·ðŸ‡º Russia</option>
                <option value="az">ðŸ‡¦ðŸ‡¿ Azerbaijan</option>
            </select>
        </div>
    </div>

    <div class="module" style="border-color:var(--primary);">
        <div class="module-header" style="cursor:default;">
            <p class="module-title" style="color:var(--primary);">4. Kanal Bul & Oynat</p>
        </div>
        <div class="module-body" style="padding-top:0; border:none;">
            <input type="text" id="filterInput" placeholder="Kanal adÄ±..." onkeyup="performSearch()">
            
            <div class="btn-group">
                <button class="btn" onclick="prevCh()"><i class="material-icons-round">skip_previous</i></button>
                <button class="btn" style="background:var(--primary)" onclick="currCh()"><i class="material-icons-round">refresh</i></button>
                <button class="btn" onclick="nextCh()"><i class="material-icons-round">skip_next</i></button>
            </div>

            <div id="searchResults"></div>
            <div id="count" style="text-align:right; font-size:0.7rem; color:#aaa; margin-top:5px;">0 Kanal</div>
        </div>
    </div>
</div>

<div class="content">
    <div id="grid" class="grid">
        <div style="grid-column:1/-1; height:60vh; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#333;">
            <i class="material-icons-round" style="font-size:80px;">downloading</i>
            <p>Liste YÃ¼kleniyor...</p>
        </div>
    </div>
</div>

<div id="playerBar" class="player-bar">
    <div style="text-align:center;">
        <h4 id="pTitle" style="margin:0; color:white;">Kanal AdÄ±</h4>
        <span id="pStatus" style="font-size:0.8rem; color:var(--primary);">HazÄ±r</span>
    </div>
</div>

<script>
    // --- 1. UI GÄ°ZLE/GÃ–STER ---
    function toggleModule(bodyId, iconId) {
        var body = document.getElementById(bodyId);
        var icon = document.getElementById(iconId);
        if (body.style.display === "none") {
            body.style.display = "block";
            icon.style.transform = "rotate(180deg)";
            icon.style.color = "var(--primary)";
        } else {
            body.style.display = "none";
            icon.style.transform = "rotate(0deg)";
            icon.style.color = "#666";
        }
    }

    // --- 2. TEMEL DEÄžÄ°ÅžKENLER ---
    let allChannels = [];
    let curIdx = -1;
    const DEFAULT_LIST = "https://iptv-org.github.io/iptv/countries/tr.m3u";

    // --- 3. BAÅžLANGIÃ‡ ---
    window.addEventListener('DOMContentLoaded', () => {
        loadUrl(DEFAULT_LIST, "TR Listesi HazÄ±r!");
    });

    // --- 4. CAST ---
    window['__onGCastApiAvailable'] = function(isAvailable) {
        if (isAvailable) {
            cast.framework.CastContext.getInstance().setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });
            const p = new cast.framework.RemotePlayer();
            const c = new cast.framework.RemotePlayerController(p);
            c.addEventListener(cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED, () => {
                const s = document.getElementById('connStatus');
                const b = document.querySelector('.conn-box');
                if (p.isConnected) {
                    s.innerText = "TV'ye BaÄŸlÄ±"; s.style.color = "#2ecc71"; b.style.borderColor = "#2ecc71";
                } else {
                    s.innerText = "BaÄŸlantÄ± Yok"; s.style.color = "#aaa"; b.style.borderColor = "#6c5ce7";
                }
            });
        }
    };

    // --- 5. LÄ°STE & SCRIPT DEDEKTÄ°FÄ° ---
    function changeCountry() {
        const val = document.getElementById('countrySelect').value;
        let url = val.startsWith('http') ? val : `https://iptv-org.github.io/iptv/countries/${val}.m3u`;
        loadUrl(url, "Liste DeÄŸiÅŸti");
    }

    async function pasteClip() { 
        try { document.getElementById('inputData').value = await navigator.clipboard.readText(); } 
        catch(e) { alert("Manuel yapÄ±ÅŸtÄ±rÄ±n."); } 
    }

    // --- GIST MASTER FONKSÄ°YONU ---
    function manualLoad() {
        let val = document.getElementById('inputData').value.trim();
        if(!val) return;

        // 1. Script Tag TemizliÄŸi
        if (val.includes('<script') && val.includes('src=')) {
            let srcMatch = val.match(/src=["'](.*?)["']/);
            if (srcMatch && srcMatch[1]) {
                val = srcMatch[1];
            }
        }

        // 2. Gist Dedektifi (Domain DeÄŸiÅŸtirme ve Raw Yapma)
        if (val.includes('gist.github.com')) {
            // .js uzantÄ±sÄ±nÄ± sil
            val = val.replace('.js', '');
            
            // Domaini deÄŸiÅŸtir (Redirect sorununu Ã§Ã¶zer)
            val = val.replace('gist.github.com', 'gist.githubusercontent.com');
            
            // Sonuna /raw ekle (EÄŸer yoksa)
            if (!val.endsWith('/raw')) {
                val = val + '/raw';
            }
            
            loadUrl(val, "Gist Ä°ndiriliyor...");
            return;
        }

        // 3. Standart YÃ¼kleme
        if(val.startsWith('http')) loadUrl(val, "Ã–zel Liste");
        else parse(val);
    }

    async function loadUrl(url, msg) {
        const stat = document.getElementById('status');
        stat.innerText = "Ä°ndiriliyor...";
        
        // GitHub Raw DÃ¼zeltmesi (Gist dÄ±ÅŸÄ± standart repolar iÃ§in)
        if(url.includes('github.com') && !url.includes('gist') && !url.includes('raw') && !url.includes('user')) {
            url = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
        }

        try {
            let res = await fetch(url);
            if(!res.ok) res = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
            if(!res.ok) throw new Error("Hata");

            const text = await res.text();
            parse(text);
            stat.innerText = msg;
        } catch(e) {
            stat.innerText = "Hata: Link aÃ§Ä±lmadÄ±";
        }
    }

    function parse(text) {
        allChannels = [];
        const lines = text.split('\n');
        let info = {};

        for (let line of lines) {
            line = line.trim();
            if(!line) continue;
            // HTML veya Script artÄ±klarÄ±nÄ± atla
            if(line.includes('document.write') || line.includes('<') || line.includes('{')) continue;

            if (line.startsWith("#EXTINF")) {
                let comma = line.lastIndexOf(',');
                let name = (comma !== -1) ? line.substring(comma+1).trim() : "Kanal";
                let logo = line.match(/tvg-logo="([^"]*)"/);
                info = { name, logo: logo?logo[1]:null };
            } else if (line.startsWith("http")) {
                if(info.name) {
                    allChannels.push({ ...info, url: line });
                    info = {};
                }
            }
        }
        document.getElementById('count').innerText = `${allChannels.length} Kanal`;
        renderGrid(allChannels);
    }

    function renderGrid(list) {
        const grid = document.getElementById('grid');
        grid.innerHTML = "";
        list.slice(0, 1000).forEach((ch, i) => {
            const div = document.createElement('div');
            div.className = `card ${i===curIdx ? 'active' : ''}`;
            div.id = `c-${i}`;
            div.onclick = () => play(i);
            
            let img = `<div class="icon-box"><i class="material-icons-round" style="color:var(--primary)">tv</i></div>`;
            if(ch.logo) img = `<div class="icon-box"><img src="${ch.logo}" onerror="this.onerror=null; this.parentNode.innerHTML='<i class=\'material-icons-round\' style=\'color:var(--primary)\'>tv</i>'"></div>`;

            div.innerHTML = `${img}<div class="info"><div class="name">${ch.name}</div></div>`;
            grid.appendChild(div);
        });
        if(list.length > 0) document.getElementById('playerBar').classList.add('show');
    }

    function performSearch() {
        const term = document.getElementById('filterInput').value.toLowerCase();
        const box = document.getElementById('searchResults');
        
        if(term.length < 2) { box.style.display = 'none'; return; }
        
        const matches = allChannels.filter(c => c.name.toLowerCase().includes(term));
        box.innerHTML = "";
        box.style.display = 'block';

        matches.slice(0, 50).forEach(ch => {
            const idx = allChannels.indexOf(ch);
            const item = document.createElement('div');
            item.className = 'result-item';
            item.innerHTML = `<i class="material-icons-round" style="color:var(--primary)">play_arrow</i> ${ch.name}`;
            item.onclick = () => play(idx);
            box.appendChild(item);
        });
    }

    function doSearch() {
        let term = document.getElementById('searchTerm').value.trim();
        if(!term) term = "iptv list";
        const url = `https://www.google.com/search?q=${encodeURIComponent('site:github.com "EXTM3U" ' + term)}`;
        window.open(url, '_blank');
    }

    function play(idx) {
        if(idx < 0 || idx >= allChannels.length) return;
        curIdx = idx;
        const ch = allChannels[idx];
        
        renderGrid(allChannels);
        document.getElementById(`c-${idx}`)?.scrollIntoView({behavior:'smooth', block:'center'});
        
        document.getElementById('pTitle').innerText = ch.name;
        document.getElementById('pStatus').innerText = "BaÄŸlanÄ±yor...";

        const session = cast.framework.CastContext.getInstance().getCurrentSession();
        if (!session) {
            document.getElementById('pStatus').innerText = "TV BaÄŸlÄ± DeÄŸil";
            return;
        }

        const media = new chrome.cast.media.MediaInfo(ch.url, 'application/x-mpegurl');
        media.metadata = new chrome.cast.media.GenericMediaMetadata();
        media.metadata.title = ch.name;
        if(ch.logo) media.metadata.images = [new chrome.cast.Image(ch.logo)];

        const req = new chrome.cast.media.LoadRequest(media);
        req.autoplay = true;

        session.loadMedia(req).then(
            () => document.getElementById('pStatus').innerText = "OynatÄ±lÄ±yor",
            () => document.getElementById('pStatus').innerText = "Hata"
        );
    }

    function nextCh() { if(allChannels.length) play(curIdx+1 >= allChannels.length ? 0 : curIdx+1); }
    function prevCh() { if(allChannels.length) play(curIdx-1 < 0 ? allChannels.length-1 : curIdx-1); }
    function currCh() { if(curIdx !== -1) play(curIdx); }
</script>

</body>
                </html>
